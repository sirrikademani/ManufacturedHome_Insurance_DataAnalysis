use database covertree;

-- https://app.snowflake.com/bikbgpw/iob02902/#/data/databases

create schema staging;

use schema staging;

create or replace TABLE COVERTREE.STAGING.POLICYHOLDER (
	POLICYHOLDER_LOCATOR VARCHAR(100) NOT NULL,
	FIRST_NAME VARCHAR(50),
	LAST_NAME VARCHAR(50),
	EMAIL_ADDRESS VARCHAR(100),
	PRIMARY_CONTACT_NUMBER VARCHAR(30),
	SECONDARY_CONTACT_NUMBER VARCHAR(30),
	MAILING_STREET_ADDRESS_POLICYHOLDER VARCHAR(100),
	MAILING_LOT_UNIT_POLICYHOLDER VARCHAR(100),
	MAILING_CITY_POLICYHOLDER VARCHAR(30),
	MAILING_STATE_POLICYHOLDER VARCHAR(14),
	MAILING_ZIP_CODE_POLICYHOLDER VARCHAR(10),
	MAILING_COUNTRY_POLICYHOLDER VARCHAR(4),
	GENDER VARCHAR(30),
	primary key (POLICYHOLDER_LOCATOR)
);

select * from covertree.staging.policyholder;


create or replace TABLE COVERTREE.STAGING.POLICY (
	POLICYHOLDER_LOCATOR VARCHAR(16777216),
	QUOTE_LOCATOR NUMBER(38,0) primary key,
	POLICY_LOCATOR NUMBER(38,0),
	STATE VARCHAR(16777216),
	ISSUED_TIMESTAMP VARCHAR(16777216),
	ISSUED_FLAG NUMBER(38,0),
	MAIN_POLICY_LOCATOR_FLAG NUMBER(38,0),
	CREATED_TIMESTAMP VARCHAR(16777216),
	POLICY_START_TIMESTAMP VARCHAR(16777216),
	POLICY_END_TIMESTAMP VARCHAR(16777216),
	DATE_OF_BIRTH DATE,
	INSURANCE_SCORE NUMBER(38,0),
	AGENCY_ID NUMBER(38,0),
	AGENT_ID NUMBER(38,0),
	PRIOR_INSURANCE VARCHAR(16777216),
	PRIOR_CARRIER_NAME VARCHAR(16777216),
	PRIOR_POLICY_EXPIRATION_DATE VARCHAR(16777216),
	APPLICATION_INTIATION VARCHAR(16777216),
	POLICY_PREMIUM NUMBER(38,0)
);

create or replace TABLE COVERTREE.STAGING.EXPOSURE_CHARACTERISTIC (
	QUOTE_LOCATOR VARCHAR(16777216),
	QUOTE_EXPOSURE_LOCATOR VARCHAR(16777216),
	QUOTE_EXPOSURE_CHARACTERISTICS_LOCATOR VARCHAR(16777216),
	COUNTRY VARCHAR(16777216),
	STATE VARCHAR(16777216),
	STREET_ADDRESS VARCHAR(16777216),
	ZIP_CODE VARCHAR(16777216),
	CITY VARCHAR(16777216),
	COUNTY VARCHAR(16777216),
	LAT NUMBER(38,6),
	LONG NUMBER(38,6),
	PROPERTY_WITH_FIRE_PROTECTION BOOLEAN,
	POLICY_USAGE VARCHAR(16777216),
	BUSINESS_ON_PREMISES BOOLEAN,
	FORM VARCHAR(16777216),
	UNIT_ID NUMBER(38,0),
	COMMUNITY_POLICY_DISCOUNT VARCHAR(16777216),
	UNIT_LOCATION VARCHAR(16777216),
	PERSONALIZED_PLAN_TYPE VARCHAR(16777216),
	HOME_TYPE VARCHAR(16777216),
	ROOF_SHAPE VARCHAR(16777216),
	SOURCE_OF_HEAT VARCHAR(16777216),
	ROOF_CONDITION VARCHAR(16777216),
	MODEL_YEAR VARCHAR(16777216),
	RCV VARCHAR(16777216),
	SWIMMING_POOL VARCHAR(16777216),
	MORTGAGE VARCHAR(16777216),
	MANUFACTURER_NAME VARCHAR(16777216),
	TOTAL_SQUARE_FOOTAGE VARCHAR(16777216),
	UNREPAIRED_DAMAGES VARCHAR(16777216),
	TRAMPOLINE_LIABILITY VARCHAR(16777216),
	ROOF_YEAR_YYYY VARCHAR(16777216),
	SECURE_RAILS VARCHAR(16777216),
	ACV VARCHAR(16777216),
	UTILITY_SERVICES VARCHAR(16777216),
	THERMO_STATIC_CONTROL VARCHAR(16777216),
	UNIT_IS_TIED VARCHAR(16777216),
	HOME_FIXTURES VARCHAR(16777216),
	ROOF_MATERIAL VARCHAR(16777216),
	UNUSUAL_RISK BOOLEAN,
	PARK_NAME VARCHAR(16777216),
	PURCHASE_DATE VARCHAR(16777216),
	BURGLAR_ALARM VARCHAR(16777216),
	STORM_MITIGATION_SHUTTERS VARCHAR(16777216),
	STORM_MITIGATION_IMPACTGLASS VARCHAR(16777216),
	STORM_MITIGATION_FORTIFIED VARCHAR(16777216),
	WROUGHT_IRON VARCHAR(16777216),
	SHORT_TERM_RENTAL_SURCHARGE VARCHAR(16777216),
	DAYCARE_ON_PREMISES VARCHAR(16777216),
	BUSINESS_EMPLOYEES_ON_PREMISES VARCHAR(16777216),
	SOURCE_OF_HEAT_INSTALLATION VARCHAR(16777216),
	TYPE_OF_FUEL VARCHAR(16777216),
	TRAMPOLINE_SAFETY_NET VARCHAR(16777216),
	VACANCY_REASON VARCHAR(16777216),
	FOUR_FEET_FENCE VARCHAR(16777216),
	DIVING_BOARD VARCHAR(16777216),
	VISITORS_IN_A_MONTH VARCHAR(16777216),
	SKIRTING_TYPE VARCHAR(16777216)
);

create or replace TABLE COVERTREE.STAGING.COVERAGES (
	QUOTE_EXPOSURE_LOCATOR VARCHAR(16777216),
	PERIL_LOCATOR VARCHAR(16777216),
	NAME VARCHAR(16777216),
	FIELD_NAME VARCHAR(16777216),
	FIELD_VALUE VARCHAR(16777216)
)

----DATA CLEANING--------------
-- Update the column to store the extracted year value
UPDATE COVERTREE.STAGING.EXPOSURE_CHARACTERISTIC
SET MODEL_YEAR = (REPLACE(MODEL_YEAR, ',', ''));

UPDATE COVERTREE.STAGING.EXPOSURE_CHARACTERISTIC
SET roof_year_yyyy = (REPLACE(roof_year_yyyy, ',', ''));